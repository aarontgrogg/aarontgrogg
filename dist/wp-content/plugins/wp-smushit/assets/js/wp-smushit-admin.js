var WP_Smush=WP_Smush||{};jQuery(function(s){WP_Smush.errors=[],WP_Smush.timeout=wp_smushit_data.timeout,WP_Smush.geturlparam=function(s){for(var t=window.location.search.substring(1),e=t.split("&"),i=0;i<e.length;i++){var n=e[i].split("=");if(n[0]==s)return n[1]}},WP_Smush.ajax=function(t,e,i,n){"use strict";return s.ajax({type:"GET",data:{attachment_id:t,get_next:i,_nonce:n},url:e,timeout:WP_Smush.timeout,dataType:"json"})},WP_Smush.Smush=function(t,e,i){var n=this;return this.init=function(n){this.$button=s(t[0]),this.is_bulk=e,this.url=ajaxurl,this.button_text=this.is_bulk?wp_smush_msgs.bulk_now:wp_smush_msgs.smush_now,this.$log=s(".smush-final-log"),this.$button_span=this.$button.find("span"),this.$loader=s(".wp-smush-loader-wrap").eq(0).clone(),this.deferred=jQuery.Deferred(),this.deferred.errors=[],this.ids=wp_smushit_data.unsmushed.length>0?wp_smushit_data.unsmushed:wp_smushit_data.lossless,this.is_bulk_super_smush=wp_smushit_data.unsmushed.length>0?!1:!0,this.lossless_count=wp_smushit_data.lossless.length,this.$status=this.$button.parent().find(".smush-status"),this.smush_type=i,this.single_ajax_suffix=this.smush_type?"smush_manual_nextgen":"wp_smushit_manual",this.bulk_ajax_suffix=this.smush_type?"wp_smushit_nextgen_bulk":"wp_smushit_bulk",this.url+=this.is_bulk?"?action="+this.bulk_ajax_suffix:"?action="+this.single_ajax_suffix},this.start=function(){this.$button.attr("disabled","disabled"),this.$button.addClass("wp-smush-started"),this.$button.find(".wp-smush-loader-wrap").length?this.$loader=this.$button.find(".wp-smush-loader-wrap"):this.$button.prepend(this.$loader),this.show_loader(),this.bulk_start(),this.single_start()},this.bulk_start=function(){this.is_bulk&&(s("#progress-ui").show(),this.$button_span.text(wp_smush_msgs.progress),this.show_loader())},this.single_start=function(){this.is_bulk||(this.$button_span.text(wp_smush_msgs.sending),this.$status.removeClass("error"))},this.enable_button=function(){this.$button.prop("disabled",!1)},this.disable_button=function(){this.$button.prop("disabled",!0)},this.show_loader=function(){this.$loader.removeClass("hidden"),this.$loader.show()},this.hide_loader=function(){this.$loader.hide()},this.single_done=function(){this.is_bulk||(this.hide_loader(),this.request.done(function(s){"undefined"!=typeof s.data&&(n.$status.html(s.data),s.success&&"Not processed"!==s.data?(n.$status.removeClass("hidden"),n.$button.parent().removeClass("unsmushed").addClass("smushed"),n.$button.remove()):n.$status.addClass("error"),n.$status.html(s.data)),n.$button_span.text(n.button_text),n.enable_button()}).error(function(s){n.$status.html(s.data),n.$status.addClass("error"),n.enable_button(),n.$button_span.text(n.button_text)}))},this.bulk_done=function(){this.is_bulk&&(this.hide_loader(),this.$button.addClass("wp-smush-finished"),this.$button.removeClass("wp-smush-started"),this.disable_button(),n.$button_span.text(wp_smush_msgs.done))},this.is_resolved=function(){"use strict";return"resolved"===this.deferred.state()},this.free_exceeded=function(){this.hide_loader(),this.$button.removeClass("wp-smush-started"),this.$button.prop("disabled",!1),this.$button.find("span").html(wp_smush_msgs.bulk_now)},this.update_progress=function(t){if(this.is_bulk_super_smush||this.is_bulk){if(this.is_bulk_super_smush)wp_smushit_data.lossless.length>0?s("#wp-smush-ss-progress-wrap .remaining-count").html(wp_smushit_data.lossless.length):0==wp_smushit_data.lossless.length&&s("#wp-smush-ss-progress-wrap #wp-smush-compression").html(wp_smush_msgs.all_supersmushed);else var e=t.data.stats.smushed/t.data.stats.total*100;s("#wp-smush-compression #human").html(t.data.stats.human),s("#wp-smush-compression #percent").html(t.data.stats.percent),this._update_progress(t.data.stats.smushed,e)}},this._update_progress=function(t,e){"use strict";if(this.is_bulk)if(this.is_bulk_super_smush){if(this.lossless_count>0){var i=this.lossless_count-wp_smushit_data.lossless.length,n=i/this.lossless_count*100,u=jQuery("#wp-smush-ss-progress-wrap #wp-smush-ss-progress div");if(u.length<1)return;u.css("width",n+"%")}}else{var u=jQuery("#wp-smush-progress-wrap #wp-smush-fetched-progress div");if(u.length<1)return;s(".done-count").html(t),u.css("width",e+"%")}},this["continue"]=function(){return this.ids.length>0&&this.is_bulk},this.increment_errors=function(){WP_Smush.errors.push(this.current_id)},this.call_ajax=function(){var s=!1,t="";return this.current_id=this.is_bulk?this.ids.shift():this.$button.data("id"),s=this.$button.parent().find("#_wp_smush_nonce"),s&&(t=s.val()),this.request=WP_Smush.ajax(this.current_id,this.url,0,t).complete(function(){n["continue"]()&&n.is_bulk||n.deferred.resolve()}).error(function(){n.increment_errors()}).done(function(s){"undefined"!=typeof s&&s&&s.success||"undefined"!=typeof s.data.error_msg&&(n.$log.append(s.data.error_msg),n["continue"]()&&n.call_ajax()),("undefined"==typeof s.success||"undefined"!=typeof s.success&&s.success===!1&&"bulk_request_image_limit_exceeded"!==s.data.error)&&n.increment_errors(),"undefined"==typeof s.data||"bulk_request_image_limit_exceeded"!=s.data.error||n.is_resolved()?(n.is_bulk&&n.update_progress(s),n["continue"]()&&n.call_ajax()):n.free_exceeded(),n.single_done()}),n.deferred.errors=WP_Smush.errors,n.deferred},this.init(arguments),this.run=function(){this.is_bulk&&this.ids.length>0&&this.call_ajax(),this.is_bulk||this.call_ajax()},this.bind_deferred_events=function(){this.deferred.done(function(){if(WP_Smush.errors.length){var s=wp_smush_msgs.error_in_bulk.replace("{{errors}}",WP_Smush.errors.length);n.$log.append(s)}n.bulk_done()})},this.start(),this.run(),this.bind_deferred_events(),this.deferred},s('button[name="smush-all"]').on("click",function(t){return t.preventDefault(),"undefined"==typeof wp_smushit_data||0==wp_smushit_data.unsmushed.length&&0==wp_smushit_data.lossless.length?!1:(s(".smush-remaining-images-notice").remove(),void new WP_Smush.Smush(s(this),!0))}),s("body").on("click","a.smush-stats-details",function(t){t.preventDefault();var e=s(this).find(".stats-toggle");s(this).parents().eq(1).find(".smush-stats-wrapper").slideToggle(),e.text("+"==e.text()?"-":"+")}),s("body").on("click",".wp-smush-send",function(t){t.preventDefault(),new WP_Smush.Smush(s(this),!1)}),s("body").on("click",".wp-smush-nextgen-send",function(t){t.preventDefault(),new WP_Smush.Smush(s(this),!1,"nextgen")}),s("body").on("click",".wp-smush-nextgen-bulk",function(t){return t.preventDefault(),"undefined"==typeof wp_smushit_data||0==wp_smushit_data.unsmushed.length&&0==wp_smushit_data.lossless.length?!1:(s(".smush-remaining-images-notice").remove(),void new WP_Smush.Smush(s(this),!0,"nextgen"))}),s(document).tooltip()}),function(s){var t=function(t,e){s(t)};s.fn.wpsmush=function(e){return this.each(function(){var i=s(this);if(!i.data("wpsmush")){var n=new t(this,e);i.data("wpsmush",n)}})}}(jQuery);
!function(e){var t=wp.media,s=s||{};s.caps=VideoPressAdminSettings.caps,s.l10n=VideoPressAdminSettings.l10n,t.controller.VideoPress=t.controller.Library.extend({defaults:_.defaults({id:"videopress",router:"videopress",toolbar:"videopress-toolbar",title:"VideoPress",priority:200,searchable:!0,sortable:!1},t.controller.Library.prototype.defaults),initialize:function(){this.get("library")||this.set("library",t.query({videopress:!0})),t.controller.Library.prototype.initialize.apply(this,arguments)},saveContentMode:function(){if("videopress"===this.get("router")){var e=this.frame.content.mode(),t=this.frame.router.get();t&&t.get(e)&&("upload_videopress"===e&&(e="upload"),setUserSetting("libraryContent",e))}}}),t.view.VideoPressUploader=t.View.extend({tagName:"div",className:"uploader-videopress",template:t.template("videopress-uploader"),events:{"submit .videopress-upload-form":"submitForm"},initialize:function(){var e=this;return window.addEventListener?window.addEventListener("message",function(){return e.messageHandler.apply(e,arguments)},!1):window.attachEvent("onmessage",function(){return e.messageHandler.apply(e,arguments)}),t.View.prototype.initialize.apply(this,arguments)},submitForm:function(){var e=!1;return this.clearErrors(),this.$('input[name="videopress_file"]').val().length<1?(this.error(s.l10n.selectVideoFile),!1):(this.$(".videopress-upload-form .button").prop("disabled",!0),t.ajax("videopress-get-upload-token",{async:!1}).done(function(t){e=t,e.success=!0}).fail(function(t){e=t,e.success=!1}),e.success?(this.error(s.l10n.videoUploading,"updated"),this.$('input[name="videopress_blog_id"]').val(e.videopress_blog_id),this.$('input[name="videopress_token"]').val(e.videopress_token),this.$(".videopress-upload-form").attr("action",e.videopress_action_url),!0):(this.$(".videopress-upload-form .button").prop("disabled",!1),this.error(e.message),!1))},error:function(t,s){s=s||"error";var i=e("<div />").html(e("<p />").text(t)).addClass(s);return this.$(".videopress-errors").html(i),this},success:function(e){return this.error(e,"updated")},clearErrors:function(){return this.$(".videopress-errors").html(""),this},messageHandler:function(e){if(e.origin.match(/\.wordpress\.com$/)&&e.data.indexOf&&0===e.data.indexOf("vpUploadResult::")){var i=JSON.parse(e.data.substr(16));if(!i||!i.code)return this.error(s.l10n.unknownError),void this.$(".videopress-upload-form .button").prop("disabled",!1);if("success"===i.code&&i.data){var r=this,o=this.controller,a=o.states.get("videopress");a.set("library",t.query({videopress:!0,vp_random:Math.random()})),a.get("library").more().done(function(){var e=a.get("library").get(i.data.attachment_id);r.clearErrors(),a.get("selection").reset([e]),o.content.mode("browse")})}else this.error(i.code),this.$(".videopress-upload-form .button").prop("disabled",!1)}}});var i=t.model.Attachment.prototype.sync;t.model.Attachment.prototype.sync=function(e,t,s){return t.get("vp_isVideoPress")&&(console.log("syncing "+t.get("vp_guid")),s.data=_.extend(s.data||{},{is_videopress:!0,vp_nonces:t.get("vp_nonces")})),i.apply(this,arguments)};var r=t.view.Attachment.Details;t.view.Attachment.Details=r.extend({initialize:function(){return this.model.get("vp_isVideoPress")&&_.extend(this.events,{"click a.videopress-preview":"vpPreview","change .vp-radio":"vpRadioChange","change .vp-checkbox":"vpCheckboxChange"}),r.prototype.initialize.apply(this,arguments)},render:function(){var e=r.prototype.render.apply(this,arguments);if(this.model.get("vp_isVideoPress")){var s=t.template("videopress-attachment"),i=this.model.toJSON();i.can={},i.can.save=!!i.nonces.update,this.$el.append(s(i))}return e},vpRadioChange:function(t){e(t.target).parents(".vp-setting").find(".vp-radio-text").val(t.target.value).change()},vpCheckboxChange:function(t){e(t.target).parents(".vp-setting").find(".vp-checkbox-text").val(Number(t.target.checked)).change()},vpPreview:function(){return l.render(this),this}});var o=t.view.UploaderWindow;t.view.UploaderWindow=o.extend({show:function(){return"videopress"!==this.controller.state().get("id")&&o.prototype.show.apply(this,arguments),this}});var a=t.view.AttachmentsBrowser;t.view.AttachmentsBrowser=a.extend({updateContent:function(){var e=this;this.attachments||this.createAttachments(),this.collection.length?e.toolbar.get("spinner").hide():(this.toolbar.get("spinner").show(),this.collection.more().done(function(){e.collection.length||e.createUploader(),e.toolbar.get("spinner").hide()}))},toggleUploader:function(){},createUploader:function(){return"videopress"!==this.controller.state().get("id")?a.prototype.createUploader.apply(this,arguments):void 0}}),_.extend(t.view.MediaFrame.prototype,{VideoPress:{activate:function(){var e=_.first(this.views.get(".media-frame-router")),t={};s.caps.read_videos&&(t.browse={text:s.l10n.VideoPressLibraryRouter,priority:40}),s.caps.upload_videos&&(t.upload_videopress={text:s.l10n.uploadVideoRouter,priority:20}),e.set(t),wp.Uploader.queue.on("add",this.VideoPress.disableUpload,this),"upload"===this.content.mode()&&s.caps.upload_videos?this.content.mode("upload_videopress"):this.content.mode("browse")},deactivate:function(){wp.Uploader.queue.off("add",this.VideoPress.disableUpload)},disableUpload:function(e){var t=this.uploader.uploader.uploader;t.stop(),t.splice(),e.destroy()},insert:function(e){var s=e.models[0].get("vp_guid").replace(/[^a-zA-Z0-9]+/,"");return t.editor.insert("[wpvideo "+s+"]"),this},uploadVideo:function(){return this.content.set(new t.view.VideoPressUploader({controller:this})),this},createToolbar:function(){if(this.options.VideoPress&&this.options.VideoPress.hideToolbar)return this;var e=this;this.toolbar.set(new t.view.Toolbar({controller:this,items:{insert:{style:"primary",text:s.l10n.insertVideoButton,priority:80,requires:{library:!0,selection:!0},click:function(){var t=e.state(),s=t.get("selection");e.close(),t.trigger("videopress:insert",s).reset()}}}}))}}});var n={};n.Select=t.view.MediaFrame.Select,t.view.MediaFrame.Select=n.Select.extend({bindHandlers:function(){n.Select.prototype.bindHandlers.apply(this,arguments),this.on("router:create:videopress",this.createRouter,this),this.on("router:activate:videopress",this.VideoPress.activate,this),this.on("router:deactivate:videopress",this.VideoPress.deactivate,this),this.on("content:render:upload_videopress",this.VideoPress.uploadVideo,this),this.on("toolbar:create:videopress-toolbar",this.VideoPress.createToolbar,this),this.on("videopress:insert",this.VideoPress.insert,this)}}),n.Post=t.view.MediaFrame.Post,t.view.MediaFrame.Post=n.Post.extend({createStates:function(){n.Post.prototype.createStates.apply(this,arguments),this.states.add([new t.controller.VideoPress])}});var d=Backbone.View.extend({className:"videopress-modal-container",template:wp.media.template("videopress-media-modal"),render:function(t){return this.delegateEvents({"click .videopress-modal-close":"closeModal","click .videopress-modal-backdrop":"closeModal"}),this.model=t.model,this.guid=this.model.get("vp_guid"),this.$frame||(this.$frame=e(".media-frame-content")),this.$el.html(this.template({video:this.model.get("vp_embed")})),this.$modal=this.$(".videopress-modal"),this.$modal.hide(),this.$frame.append(this.$el),this.$modal.slideDown("fast"),this},closeModal:function(){var e=this;return this.$modal.slideUp("fast",function(){e.remove()}),this}}),l=new d;e(document).on("ready",function(){var t=e("#videopress-settings");if(t.length){var s=t.find('input[name="videopress-access"]'),i=t.find('input[name="videopress-upload"]');s.on("change",function(){var e=s.filter(":checked").val();i.attr("disabled",!e),e||i.attr("checked",!1)}),s.trigger("change")}}),e(document).on("click","#videopress-browse",function(){return wp.media({state:"videopress",states:[new t.controller.VideoPress],VideoPress:{hideToolbar:!0}}).open(),!1})}(jQuery);